<style>
/* Chat Button - Rounded Rectangle */
#chatkit-button {
    position: fixed;
    bottom: 24px;
    right: 24px;
    width: 70px;
    height: 70px;
    border-radius: 16px;
    background: #133672;
    box-shadow: 0 4px 16px rgba(19, 54, 114, 0.4), 0 2px 8px rgba(0, 0, 0, 0.1);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 999998;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
#chatkit-button:hover {
    transform: scale(1.08);
    box-shadow: 0 6px 24px rgba(19, 54, 114, 0.5), 0 4px 12px rgba(0, 0, 0, 0.15);
}
#chatkit-button:active {
    transform: scale(0.95);
}
#chatkit-button svg {
    width: 32px;
    height: 32px;
    fill: white;
    transition: transform 0.3s ease;
}
#chatkit-button.open svg.chat-icon {
    display: none;
}
#chatkit-button.open svg.close-icon {
    display: block;
}
#chatkit-button svg.close-icon {
    display: none;
}

/* Popup bubble */
#chatkit-popup {
    position: fixed;
    bottom: 104px;
    right: 24px;
    background: white;
    padding: 14px 20px;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    z-index: 999997;
    opacity: 0;
    transform: translateY(10px) scale(0.95);
    transition: all 0.3s ease;
    pointer-events: none;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 15px;
    font-weight: 500;
    color: #333;
    cursor: pointer;
}
#chatkit-popup.show {
    opacity: 1;
    transform: translateY(0) scale(1);
    pointer-events: auto;
}
#chatkit-popup:hover {
    background: #f5f5f5;
}
#chatkit-popup::after {
    content: '';
    position: absolute;
    bottom: -6px;
    right: 32px;
    width: 12px;
    height: 12px;
    background: white;
    transform: rotate(45deg);
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.05);
}

/* Chat Window */
#chatkit-window {
    position: fixed;
    bottom: 104px;
    right: 24px;
    width: 400px;
    height: 600px;
    max-height: calc(100vh - 140px);
    background: #0a1628;
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    z-index: 999999;
    display: none;
    flex-direction: column;
    overflow: hidden;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}
#chatkit-window.open {
    display: flex;
}

/* Header */
#chatkit-header {
    background: linear-gradient(135deg, #133672 0%, #1a4a9e 100%);
    padding: 16px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
#chatkit-header-left {
    display: flex;
    align-items: center;
    gap: 12px;
}
#chatkit-header-title {
    color: white;
    font-size: 18px;
    font-weight: 600;
}
#chatkit-header-status {
    display: flex;
    align-items: center;
    gap: 6px;
    color: rgba(255, 255, 255, 0.8);
    font-size: 13px;
}
#chatkit-header-status::before {
    content: '';
    width: 8px;
    height: 8px;
    background: #4ade80;
    border-radius: 50%;
}

/* Messages Area */
#chatkit-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
}

/* Welcome Message */
#chatkit-welcome {
    text-align: center;
    padding: 40px 20px;
}
#chatkit-welcome h2 {
    color: white;
    font-size: 24px;
    font-weight: 600;
    margin: 0 0 20px 0;
}
#chatkit-suggestions {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 10px;
}
.chatkit-suggestion {
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(255, 255, 255, 0.05);
    padding: 12px 16px;
    border-radius: 10px;
    color: rgba(255, 255, 255, 0.7);
    cursor: pointer;
    transition: background 0.2s;
    font-size: 14px;
}
.chatkit-suggestion:hover {
    background: rgba(255, 255, 255, 0.1);
}
.chatkit-suggestion svg {
    width: 18px;
    height: 18px;
    fill: rgba(255, 255, 255, 0.5);
    flex-shrink: 0;
}

/* Message Bubbles */
.chatkit-message {
    max-width: 85%;
    padding: 12px 16px;
    border-radius: 12px;
    font-size: 14px;
    line-height: 1.6;
    word-wrap: break-word;
    overflow-wrap: break-word;
}
.chatkit-message.user {
    background: #133672;
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 4px;
}
.chatkit-message.assistant {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    align-self: flex-start;
    border-bottom-left-radius: 4px;
}
.chatkit-message a {
    color: #60a5fa;
    text-decoration: underline;
}
.chatkit-message strong {
    font-weight: 600;
}

/* Input Area */
#chatkit-input-area {
    padding: 16px 20px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}
#chatkit-input-wrapper {
    display: flex;
    align-items: center;
    gap: 12px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    padding: 8px 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: border-color 0.2s;
}
#chatkit-input-wrapper:focus-within {
    border-color: rgba(255, 255, 255, 0.3);
}
#chatkit-input {
    flex: 1;
    background: none;
    border: none;
    color: white;
    font-size: 14px;
    outline: none;
}
#chatkit-input::placeholder {
    color: rgba(255, 255, 255, 0.4);
}
#chatkit-send {
    background: white;
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s;
    color: #133672;
    font-size: 18px;
}
#chatkit-send:hover {
    transform: scale(1.05);
}

/* Typing Indicator */
.chatkit-typing-dots {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 4px 0;
}
.chatkit-typing-dots span {
    width: 8px;
    height: 8px;
    background: rgba(255, 255, 255, 0.5);
    border-radius: 50%;
    animation: typingBounce 1.4s ease-in-out infinite;
}
.chatkit-typing-dots span:nth-child(1) { animation-delay: 0s; }
.chatkit-typing-dots span:nth-child(2) { animation-delay: 0.2s; }
.chatkit-typing-dots span:nth-child(3) { animation-delay: 0.4s; }
@keyframes typingBounce {
    0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.4;
    }
    30% {
        transform: translateY(-6px);
        opacity: 1;
    }
}

/* Mobile Responsive */
@media (max-width: 480px) {
    #chatkit-window {
        width: calc(100vw - 20px);
        height: calc(100vh - 100px);
        right: 10px;
        bottom: 94px;
        border-radius: 12px;
    }
    #chatkit-button {
        right: 16px;
        bottom: 16px;
        width: 60px;
        height: 60px;
    }
    #chatkit-popup {
        right: 16px;
        bottom: 86px;
    }
}
</style>

<!-- Popup Bubble -->
<div id="chatkit-popup">How can I help?</div>

<!-- Chat Button -->
<button id="chatkit-button" aria-label="Open chat">
    <svg class="chat-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
    </svg>
    <svg class="close-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
    </svg>
</button>

<!-- Chat Window -->
<div id="chatkit-window">
    <div id="chatkit-header">
        <div id="chatkit-header-left">
            <div>
                <div id="chatkit-header-title">Waterfield Tech</div>
                <div id="chatkit-header-status">Online</div>
            </div>
        </div>
    </div>
    <div id="chatkit-messages">
        <div id="chatkit-welcome">
            <h2>How can I help you today?</h2>
            <div id="chatkit-suggestions">
                <div class="chatkit-suggestion" data-prompt="Tell me about Applied AI solutions">
                    <svg viewBox="0 0 24 24"><path d="M21 10.12h-6.78l2.74-2.82c-2.73-2.7-7.15-2.8-9.88-.1-2.73 2.71-2.73 7.08 0 9.79s7.15 2.71 9.88 0C18.32 15.65 19 14.08 19 12.1h2c0 1.98-.88 4.55-2.64 6.29-3.51 3.48-9.21 3.48-12.72 0-3.5-3.47-3.5-9.12 0-12.6 3.51-3.47 9.14-3.47 12.65 0L21 3v7.12zM12.5 8v4.25l3.5 2.08-.72 1.21L11 13V8h1.5z"/></svg>
                    Tell me about Applied AI solutions
                </div>
                <div class="chatkit-suggestion" data-prompt="What is CX Modernization?">
                    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                    What is CX Modernization?
                </div>
                <div class="chatkit-suggestion" data-prompt="How can you help with cloud migration?">
                    <svg viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z"/></svg>
                    How can you help with cloud migration?
                </div>
            </div>
        </div>
    </div>
    <div id="chatkit-input-area">
        <div id="chatkit-input-wrapper">
            <input type="text" id="chatkit-input" placeholder="Ask anything..." />
            <button id="chatkit-send" aria-label="Send message">âž¤</button>
        </div>
    </div>
</div>

<script>
(function() {
    const chatButton = document.getElementById('chatkit-button');
    const chatWindow = document.getElementById('chatkit-window');
    const chatPopup = document.getElementById('chatkit-popup');
    const chatInput = document.getElementById('chatkit-input');
    const chatSend = document.getElementById('chatkit-send');
    const messagesContainer = document.getElementById('chatkit-messages');
    const welcomeSection = document.getElementById('chatkit-welcome');
    const suggestions = document.querySelectorAll('.chatkit-suggestion');

    let isOpen = false;
    let popupShown = false;

    // Simple markdown to HTML converter
    function parseMarkdown(text) {
        let html = text
            // Bold **text** (non-greedy, handles across content)
            .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
            // Links [text](url)
            .replace(/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>')
            // Standalone URLs
            .replace(/(^|[^"'])(https?:\/\/[^\s<]+)/g, '$1<a href="$2" target="_blank" rel="noopener">$2</a>')
            // Line breaks
            .replace(/\n/g, '<br>');
        return html;
    }

    // Show popup after 5 seconds
    setTimeout(function() {
        if (!isOpen && !popupShown) {
            chatPopup.classList.add('show');
            popupShown = true;
        }
    }, 5000);

    // Click popup to open chat
    chatPopup.addEventListener('click', function() {
        chatPopup.classList.remove('show');
        toggleChat();
    });

    // Toggle chat window
    function toggleChat() {
        isOpen = !isOpen;
        chatButton.classList.toggle('open', isOpen);
        chatWindow.classList.toggle('open', isOpen);

        // Hide popup when chat opens
        if (isOpen) {
            chatPopup.classList.remove('show');
        }
    }

    chatButton.addEventListener('click', toggleChat);

    const API_URL = 'https://website-chatkit-git-main-damianmathews-1710s-projects.vercel.app/api/chat';

    // Send message function
    async function sendMessage(text) {
        if (!text.trim()) return;

        // Hide welcome section
        if (welcomeSection) {
            welcomeSection.style.display = 'none';
        }

        // Add user message
        const userMsg = document.createElement('div');
        userMsg.className = 'chatkit-message user';
        userMsg.textContent = text;
        messagesContainer.appendChild(userMsg);

        // Clear input
        chatInput.value = '';

        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        // Show typing indicator
        const typingMsg = document.createElement('div');
        typingMsg.className = 'chatkit-message assistant';
        typingMsg.id = 'chatkit-typing';
        typingMsg.innerHTML = '<div class="chatkit-typing-dots"><span></span><span></span><span></span></div>';
        messagesContainer.appendChild(typingMsg);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ input_as_text: text })
            });

            // Remove typing indicator
            const typing = document.getElementById('chatkit-typing');
            if (typing) typing.remove();

            if (!response.ok) {
                throw new Error('Network response was not ok');
            }

            const data = await response.json();

            // Add bot response
            const botMsg = document.createElement('div');
            botMsg.className = 'chatkit-message assistant';
            const responseText = data.output_text || data.response || data.message || "I'm sorry, I couldn't process that request.";
            botMsg.innerHTML = parseMarkdown(responseText);
            messagesContainer.appendChild(botMsg);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

        } catch (error) {
            console.error('Chat error:', error);
            // Remove typing indicator
            const typing = document.getElementById('chatkit-typing');
            if (typing) typing.remove();

            const errorMsg = document.createElement('div');
            errorMsg.className = 'chatkit-message assistant';
            errorMsg.textContent = "Sorry, I'm having trouble connecting. Please try again.";
            messagesContainer.appendChild(errorMsg);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    }

    // Send on button click
    chatSend.addEventListener('click', function() {
        sendMessage(chatInput.value);
    });

    // Send on Enter key
    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage(chatInput.value);
        }
    });

    // Welcome suggestion clicks
    suggestions.forEach(function(suggestion) {
        suggestion.addEventListener('click', function() {
            const prompt = this.getAttribute('data-prompt');
            sendMessage(prompt);
        });
    });
})();
</script>
